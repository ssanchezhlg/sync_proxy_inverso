- name: Copiar contenido de la carpeta sites-available al servidor Ngnix1
  hosts: all
#  become: yes

  tasks:
    - name: Verificar si rsync está instalado
      command: which rsync
      register: rsync_installed
      ignore_errors: true
    
    - name: Instalar rsync si no está instalado
      package:
        name: rsync
        state: present
      when: rsync_installed.rc != 0

    - name: Copiar carpeta usando rsync
      synchronize:
        src: sites-available-rsync/
        dest: /home/PruebaAnsible/Rsync/sites-available/
        delete: yes
        recursive: yes
        checksum: yes
        archive: no
        compress: yes
        times: yes

#    - name: Establecer permisos en los archivos copiados
#      file:
#        path: /home/PruebaAnsible/Rsync/sites-available
#        path: /home/PruebaAnsible/Rsync/sites-enabled
#        mode: "u=rw,g=r,o=r"
#        owner: root
#        recurse: yes     

    - name: Obtener la lista de archivos en sites-available
      find:
        paths: /home/PruebaAnsible/Rsync/sites-available
        patterns: "*"
      register: files_to_link

    - name: Crear enlaces simbólicos en sites-enabled
      file:
        src: "/home/PruebaAnsible/Rsync/sites-available/{{ item.path | basename }}"
        dest: "/home/PruebaAnsible/Rsync/sites-enabled/{{ item.path | basename }}"
        state: link
      with_items: "{{ files_to_link.files }}"	
      